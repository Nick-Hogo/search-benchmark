# 模块 03：结果分析逻辑

本模块定义如何分析测试答案的质量。

## 输入

从 `02-execution.md` 模块接收：
```json
{
  "test_case_id": "T1-freshness-7days",
  "test_case": {完整的测试用例对象},
  "answer": "生成的完整答案",
  "raw_search_results": {搜索工具返回的JSON},
  "search_start": 1738410615123,
  "search_end": 1738410618456,
  "answer_end": 1738410621234
}
```

---

## 分析流程

### 步骤 1：统计基础数据

```
从原始搜索结果和答案中提取统计数据：

1. 搜索结果统计
   - 搜索返回总条数
   - 搜索耗时（秒）
   - 结果来源分布（域名统计）

2. 答案统计
   - 输出文本长度（字符数）
   - 分析耗时（秒）
   - 总耗时（秒）
   - 引用的来源数量
   - 提及的日期数量（如适用）
```

### 步骤 2：基于判定标准进行分析

**重要**：此时你需要切换角色，从"答题者"变为"分析者"。

```
根据 test_case.judgment_criteria 中的检查维度，逐条分析：

对每个 criterion:
  1. 读取 check_method（检查方法）
  2. 在答案和原始搜索结果中验证
  3. 统计符合/不符合的情况
  4. 记录发现的问题和现象
  5. 进行客观论述

保持客观：
  - 只陈述观察到的事实
  - 统计具体数据（数量、比例、时间等）
  - 指出存在的问题及其具体表现
  - 不进行主观打分
```

### 步骤 3：生成分析报告

```markdown
## [{test_case_id}] {test_case_name} - 分析报告

### 基础统计

| 指标 | 数值 |
|------|------|
| 搜索返回条数 | {count} |
| 搜索耗时 | {X.XX}秒 |
| 分析耗时 | {X.XX}秒 |
| 总耗时 | {X.XX}秒 |
| 输出文本长度 | {count}字符 |
| 引用来源数 | {count} |

### 检测目的

{test_case.category} - {test_case_name}

本测试旨在检测：{根据测试用例的目的进行论述}

### 分析结果

#### {判定维度 1}

**检查方法**: {criterion.check_method}

**观察结果**:
- 搜索结果中共 {X} 条消息
- 其中 {Y} 条符合要求
- {Z} 条存在以下问题：
  * 问题1: {具体描述，如"日期超出7天窗口"}，涉及 {N} 条
  * 问题2: {具体描述}，涉及 {M} 条

**具体案例**:
{列举1-2个典型案例，说明问题所在}

#### {判定维度 2}

{同上格式}

### 综合评述

{针对检测目的，综合论述工具在此测试中的表现，包括：}
- 优势表现
- 存在的问题
- 可能的原因分析
```

---

## 分析维度详解

### 时效性（Timeliness）

```
核心检查点：
1. 日期验证
   - 提取答案中所有日期
   - 提取搜索结果中的日期
   - 计算距今天数
   - 统计在/超出时间窗口的数量

2. 时间范围标注
   - 答案是否明确说明统计区间
   - 是否使用绝对日期

分析输出：
- 搜索结果中 X 条，其中 Y 条在时间窗口内，Z 条超出
- 超出的具体是哪些，日期是多少
- 答案是否正确标注了时间范围
```

### 准确度（Factuality）

```
核心检查点：
1. 事实核查
   - 关键事实是否可被搜索结果验证
   - 是否存在与搜索结果不符的内容

2. 来源质量
   - 引用来源的类型分布（官方/博客/论坛等）
   - 是否符合测试要求

分析输出：
- 答案中提到的 X 个事实，Y 个可被搜索结果验证，Z 个无法验证
- 引用来源：官方文档 A 条，技术博客 B 条，其他 C 条
- 存在的问题：{具体列举}
```

### 抗幻觉（Anti-hallucination）

```
核心检查点：
1. 虚假信息识别
   - 对于诱导性问题，是否正确拒绝
   - 是否编造了搜索结果中不存在的信息

2. 不确定性处理
   - 信息不足时的处理方式

分析输出：
- 答案是否识别出虚假信息：是/否
- 是否提供反证：是/否
- 是否编造内容：是/否，具体是什么
```

### 可核查性（Verifiability）

```
核心检查点：
1. 引用完整性
   - 每个主张是否有对应来源
   - 链接是否存在

2. 引用质量
   - 来源是否真的支持该主张
   - 是否出现"引用堆砌"

分析输出：
- 答案中 X 个主张，Y 个有独立引用，Z 个缺少引用
- 引用堆砌情况：{具体说明}
- 引用与主张不符的案例：{具体列举}
```

### 效率（Efficiency）

```
核心检查点：
1. 响应时间
   - 搜索耗时
   - 分析耗时
   - 总耗时

2. 输出质量
   - 是否为速度牺牲了准确性
   - 输出长度是否合理

分析输出：
- 搜索耗时 X 秒，分析耗时 Y 秒，总耗时 Z 秒
- 输出长度 M 字符
- 时间与质量的权衡分析
```

---

## 输出格式

分析完成后，生成 Markdown 格式的分析报告，保存到：
```
{session_dir}/analysis/{tool_id}_analysis.md
```

报告结构参考步骤3中的模板。

---

## 分析一致性

在同一个测试会话中，对相同检查维度的分析应保持一致：

```
示例：
如果在测试用例 #1 中，认为"未明确时间范围"是问题
那么在测试用例 #2 中遇到相同情况，也应指出为问题

保持记录：
  建议在内存中维护一个"分析决策日志"
  记录每个判定标准的分析案例
  后续分析时参考，确保一致性
```
