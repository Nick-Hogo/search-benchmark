# 模块 03：结果分析逻辑

## 目录

- [输入数据](#输入数据)
- [执行清单](#执行清单)
  - [步骤 1：统计基础数据](#步骤-1统计基础数据)
  - [步骤 2：基于判定标准进行分析](#步骤-2基于判定标准进行分析)
  - [步骤 3：生成分析报告](#步骤-3生成分析报告)
  - [步骤 4：保存分析结果](#步骤-4保存分析结果)
- [分析维度详解](#分析维度详解)
- [输出格式](#输出格式)
- [分析一致性](#分析一致性)

---

## 输入数据

从阶段二接收的数据：

```
输入来源：
  - 答卷文件：{session_dir}/answers/{tool_id}.md
  - 测试配置：data/test-cases.yml（用于获取判定标准）

包含信息：
  - 所有测试问题的原始搜索结果
  - 所有测试问题的Claude生成答案
  - 时间戳和耗时数据
```

---

## 执行清单

按照以下步骤逐项完成分析任务。**每完成一步，在思考过程中标记为已完成**。

### 步骤 1：统计基础数据

对于每个测试问题，从答卷文件中提取并统计：

- [ ] 提取搜索结果统计
  ```
  - 搜索返回总条数
  - 搜索耗时（秒）
  - 结果来源分布（域名统计）
    示例：
      docs.github.com: 3条
      stackoverflow.com: 2条
      medium.com: 1条
  ```

- [ ] 提取答案统计
  ```
  - 输出文本长度（字符数）
  - 分析耗时（秒）
  - 总耗时（秒）
  - 引用的来源数量
  - 提及的日期数量（如适用）
  ```

- [ ] 记录统计数据
  ```
  保存到内存对象中，供后续分析使用
  ```

---

### 步骤 2：基于判定标准进行分析

**重要**：此时你需要切换角色，从"答题者"变为"分析者"。

- [ ] 加载判定标准
  ```
  从 test_case.judgment_criteria 中读取所有检查维度
  ```

- [ ] 对每个 criterion 逐条分析
  ```
  对每个判定标准：
    1. 读取 check_method（检查方法）
    2. 在答案和原始搜索结果中验证
    3. 统计符合/不符合的情况
    4. 记录发现的问题和现象
    5. 进行客观论述
  ```

- [ ] 保持客观性
  ```
  分析原则：
    - 只陈述观察到的事实
    - 统计具体数据（数量、比例、时间等）
    - 指出存在的问题及其具体表现
    - 不进行主观打分
    - 不使用"好"、"差"等评价性词汇
    - 用数据说话
  ```

- [ ] 识别典型案例
  ```
  对于每个分析维度，找出1-2个典型案例：
    - 符合标准的优秀案例
    - 不符合标准的问题案例
  记录具体内容，用于报告中的说明
  ```

---

### 步骤 3：生成分析报告

- [ ] 构建分析报告结构
  ```markdown
  ## [{test_case_id}] {test_case_name} - 分析报告

  ### 基础统计

  | 指标 | 数值 |
  |------|------|
  | 搜索返回条数 | {count} |
  | 搜索耗时 | {X.XX}秒 |
  | 分析耗时 | {X.XX}秒 |
  | 总耗时 | {X.XX}秒 |
  | 输出文本长度 | {count}字符 |
  | 引用来源数 | {count} |

  ### 检测目的

  {test_case.category} - {test_case_name}

  本测试旨在检测：{根据测试用例的目的进行论述}

  ### 分析结果

  #### {判定维度 1}

  **检查方法**: {criterion.check_method}

  **观察结果**:
  - 搜索结果中共 {X} 条消息
  - 其中 {Y} 条符合要求
  - {Z} 条存在以下问题：
    * 问题1: {具体描述，如"日期超出7天窗口"}，涉及 {N} 条
    * 问题2: {具体描述}，涉及 {M} 条

  **具体案例**:
  {列举1-2个典型案例，说明问题所在}

  #### {判定维度 2}

  {同上格式}

  ### 综合评述

  {针对检测目的，综合论述工具在此测试中的表现，包括：}
  - 优势表现
  - 存在的问题
  - 可能的原因分析
  ```

- [ ] 填充报告内容
  ```
  使用步骤1和步骤2中收集的数据填充报告模板
  确保所有数据准确无误
  ```

---

### 步骤 4：保存分析结果

- [ ] 汇总所有问题的分析
  ```
  将所有测试问题的分析报告合并到一个文件中
  ```

- [ ] 写入分析文件
  ```bash
  Write: {session_dir}/analysis/{tool_id}_analysis.md

  文件内容：
    # {Tool Name} 分析报告

    **生成时间**: {timestamp}
    **测试用例数**: {count}

    ---

    {所有问题的分析报告}

    ---

    ## 总体分析

    {基于所有问题的分析，给出总体评述}
  ```

- [ ] 更新日志文件
  ```bash
  使用 Bash 工具的 cat >> 追加记录：

  cat >> "{session_dir}/_test_log.jsonl" << 'EOF'
  {"type": "analysis_completed", "tool": "{tool_id}", "timestamp": {ts}}
  EOF
  ```

- [ ] 显示完成信息
  ```
  ✅ [{tool}] 分析完成
  ```

---

## 分析维度详解

### 时效性（Timeliness）

- [ ] 检查要点
  ```
  1. 日期验证
     - 提取答案中所有日期
     - 提取搜索结果中的日期
     - 计算距今天数
     - 统计在/超出时间窗口的数量

  2. 时间范围标注
     - 答案是否明确说明统计区间
     - 是否使用绝对日期
  ```

- [ ] 分析输出示例
  ```
  - 搜索结果中 8 条，其中 5 条在7天窗口内，3 条超出
  - 超出的具体条目：
    * 第3条：发布日期 2026-01-20（超出9天）
    * 第6条：发布日期 2026-01-18（超出11天）
    * 第8条：未标注日期
  - 答案明确标注了统计区间"2026-01-26 至 2026-02-02"
  ```

---

### 准确度（Factuality）

- [ ] 检查要点
  ```
  1. 事实核查
     - 关键事实是否可被搜索结果验证
     - 是否存在与搜索结果不符的内容

  2. 来源质量
     - 引用来源的类型分布（官方/博客/论坛等）
     - 是否符合测试要求
  ```

- [ ] 分析输出示例
  ```
  - 答案中提到的 5 个事实，4 个可被搜索结果验证，1 个无法验证
  - 引用来源分布：
    * 官方文档：3 条 (60%)
    * 技术博客：1 条 (20%)
    * 其他：1 条 (20%)
  - 存在的问题：
    * "并发限制为25个"与官方文档"20个"不符
  ```

---

### 抗幻觉（Anti-hallucination）

- [ ] 检查要点
  ```
  1. 虚假信息识别
     - 对于诱导性问题，是否正确拒绝
     - 是否编造了搜索结果中不存在的信息

  2. 不确定性处理
     - 信息不足时的处理方式
  ```

- [ ] 分析输出示例
  ```
  - 问题包含虚假信息："GPT-5.5是否已发布"
  - 答案正确识别：是 ✅
  - 提供反证：是 ✅（引用了OpenAI官方博客）
  - 是否编造内容：否 ✅
  - 评价：成功识别虚假信息，提供了充分的反证
  ```

---

### 可核查性（Verifiability）

- [ ] 检查要点
  ```
  1. 引用完整性
     - 每个主张是否有对应来源
     - 链接是否存在

  2. 引用质量
     - 来源是否真的支持该主张
     - 是否出现"引用堆砌"
  ```

- [ ] 分析输出示例
  ```
  - 答案中 3 个主张，3 个有独立引用 (100%)
  - 引用堆砌情况：未发现 ✅
  - 引用质量检查：
    * 主张1："REST通过多个端点" → 来源支持 ✅
    * 主张2："GraphQL按需请求" → 来源支持 ✅
    * 主张3："性能优势" → 来源支持 ✅
  ```

---

### 效率（Efficiency）

- [ ] 检查要点
  ```
  1. 响应时间
     - 搜索耗时
     - 分析耗时
     - 总耗时

  2. 输出质量
     - 是否为速度牺牲了准确性
     - 输出长度是否合理
  ```

- [ ] 分析输出示例
  ```
  - 搜索耗时：4.2秒
  - 分析耗时：2.8秒
  - 总耗时：7.0秒
  - 输出长度：280字符（符合要求的200字以内）
  - 时间与质量权衡：在保证准确性的前提下，响应速度合理
  ```

---

## 输出格式

分析完成后，生成 Markdown 格式的分析报告，保存到：

```
{session_dir}/analysis/{tool_id}_analysis.md
```

报告包含：
- 每个测试问题的详细分析
- 基础统计数据
- 各维度的检查结果
- 典型案例说明
- 综合评述

---

## 分析一致性

在同一个测试会话中，对相同检查维度的分析应保持一致：

```
示例：
如果在测试用例 #1 中，认为"未明确时间范围"是问题
那么在测试用例 #2 中遇到相同情况，也应指出为问题

保持记录：
  建议在内存中维护一个"分析决策日志"
  记录每个判定标准的分析案例
  后续分析时参考，确保一致性
```

**分析原则**：
- 同样的问题，给出同样的评价
- 同样的优点，给出同样的认可
- 使用相同的衡量标准
- 保持客观中立
